name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 'latest'
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
          cache-dependency-path: 'turn2app/pnpm-lock.yaml'
      
      - name: Install dependencies
        working-directory: ./turn2app
        run: pnpm install --frozen-lockfile
      
      - name: Type checking
        working-directory: ./turn2app
        run: pnpm typecheck
      
      - name: Lint code
        working-directory: ./turn2app
        run: pnpm lint --max-warnings 0
        continue-on-error: true  # ESLint config may need fixing
      
      - name: Run tests
        working-directory: ./turn2app
        run: pnpm test --run --reporter=verbose
        env:
          DATABASE_URL: "file:./test.sqlite"
          SESSION_KEYS: "test-key-1,test-key-2"
          ENCRYPTION_KEY: "771e7c2bd446e561076a5e23307f2940ef677a137c534c56545f61802d0087c7"
          SHOPIFY_API_KEY: "test-api-key"
          SHOPIFY_API_SECRET: "test-api-secret"
          APP_URL: "http://localhost:3000"
      
      - name: Check database schema
        working-directory: ./turn2app
        run: pnpm db:generate
        env:
          DATABASE_URL: "file:./test.sqlite"
      
      - name: Upload test coverage
        uses: actions/upload-artifact@v3
        if: matrix.node-version == 20
        with:
          name: coverage-report
          path: turn2app/coverage/
          retention-days: 30

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 'latest'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: 'turn2app/pnpm-lock.yaml'
      
      - name: Install dependencies
        working-directory: ./turn2app
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        working-directory: ./turn2app
        run: pnpm build
        env:
          DATABASE_URL: "file:./build.sqlite"
          SESSION_KEYS: "build-key-1,build-key-2"
          ENCRYPTION_KEY: "771e7c2bd446e561076a5e23307f2940ef677a137c534c56545f61802d0087c7"
          SHOPIFY_API_KEY: "build-api-key"
          SHOPIFY_API_SECRET: "build-api-secret"
          APP_URL: "http://localhost:3000"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |
            turn2app/build/
            turn2app/public/build/
          retention-days: 7

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 'latest'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: 'turn2app/pnpm-lock.yaml'
      
      - name: Install dependencies
        working-directory: ./turn2app
        run: pnpm install --frozen-lockfile
      
      - name: Run security audit
        working-directory: ./turn2app
        run: pnpm audit --audit-level moderate
        continue-on-error: true
      
      - name: Check for outdated packages
        working-directory: ./turn2app
        run: pnpm outdated
        continue-on-error: true